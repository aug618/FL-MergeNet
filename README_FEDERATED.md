# è”é‚¦å­¦ä¹  + MergeNet å®ç°

æœ¬é¡¹ç›®å®ç°äº†è”é‚¦å­¦ä¹ ä¸MergeNetçŸ¥è¯†èåˆçš„ç»“åˆï¼Œåœ¨åŸæœ‰çš„MobileNetV2ä»ResNet50èåˆçŸ¥è¯†çš„åŸºç¡€ä¸Šï¼ŒåŠ å…¥äº†è”é‚¦å¹³å‡çš„è®­ç»ƒæœºåˆ¶ã€‚

## ğŸ¯ æ ¸å¿ƒæ€æƒ³

åœ¨åŸå§‹çš„`run_res50_mbv2.py`ä¸­ï¼ŒMobileNetV2æ¯éš”`f`ä¸ªbatchä»ResNet50èåˆä¸€æ¬¡çŸ¥è¯†ã€‚ç°åœ¨æˆ‘ä»¬åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åŠ å…¥è”é‚¦å­¦ä¹ ï¼š

1. **è”é‚¦å¹³å‡**: å¤šä¸ªå®¢æˆ·ç«¯è®­ç»ƒMobileNetV2æ¨¡å‹
2. **æœåŠ¡ç«¯èšåˆ**: æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯æ¨¡å‹è¿›è¡Œè”é‚¦å¹³å‡
3. **çŸ¥è¯†èåˆ**: å¹³å‡åçš„æ¨¡å‹ä»ResNet50èåˆçŸ¥è¯†
4. **å‚æ•°åˆ†å‘**: èåˆçŸ¥è¯†åçš„æ¨¡å‹å‚æ•°åˆ†å‘ç»™å®¢æˆ·ç«¯

## ğŸ“ æ–‡ä»¶ç»“æ„

```
federated_mergenet/
â”œâ”€â”€ federated_mergenet_server.py    # è”é‚¦å­¦ä¹ æœåŠ¡ç«¯ï¼ˆå«çŸ¥è¯†èåˆï¼‰
â”œâ”€â”€ federated_mergenet_client.py    # è”é‚¦å­¦ä¹ å®¢æˆ·ç«¯
â”œâ”€â”€ run_federated_mergenet.py       # å®éªŒå¯åŠ¨è„šæœ¬
â”œâ”€â”€ compare_results.py              # ç»“æœå¯¹æ¯”åˆ†æ
â”œâ”€â”€ start_federated_experiment.sh   # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ federated_mergenet_config.py # è”é‚¦å­¦ä¹ é…ç½®
â”‚   â””â”€â”€ param_attention_config.yaml  # åŸæœ‰MergeNeté…ç½®
â”œâ”€â”€ requirements_federated.txt       # ä¾èµ–åŒ…
â””â”€â”€ results/                        # å®éªŒç»“æœ
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements_federated.txt

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p logs/federated checkpoints/federated results
```

### 2. ä½¿ç”¨å¿«é€Ÿå¯åŠ¨è„šæœ¬

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
chmod +x start_federated_experiment.sh

# å¯åŠ¨å®éªŒ
./start_federated_experiment.sh
```

### 3. æ‰‹åŠ¨å¯åŠ¨

#### å¯åŠ¨æœåŠ¡ç«¯
```bash
python federated_mergenet_server.py
```

#### å¯åŠ¨å®¢æˆ·ç«¯ï¼ˆéœ€è¦å¤šä¸ªç»ˆç«¯ï¼‰
```bash
# å®¢æˆ·ç«¯1
python federated_mergenet_client.py --client_id 0 --device cuda

# å®¢æˆ·ç«¯2  
python federated_mergenet_client.py --client_id 1 --device cpu

# å®¢æˆ·ç«¯3
python federated_mergenet_client.py --client_id 2 --device cuda
```

#### å®Œæ•´å®éªŒå¯åŠ¨
```bash
# å¯åŠ¨3ä¸ªå®¢æˆ·ç«¯çš„å®Œæ•´å®éªŒ
python run_federated_mergenet.py --num_clients 3
```

## ğŸ“Š å®éªŒå¯¹æ¯”

### ä¸åŸå§‹æ–¹æ³•å¯¹æ¯”
```bash
# ç”Ÿæˆå¯¹æ¯”åˆ†æ
python compare_results.py

# æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬
python run_federated_mergenet.py --compare
```

### é¢„æœŸæ”¹è¿›

1. **åˆ†å¸ƒå¼è®­ç»ƒ**: å¤šå®¢æˆ·ç«¯å¹¶è¡Œè®­ç»ƒï¼Œæé«˜è®­ç»ƒæ•ˆç‡
2. **çŸ¥è¯†èšåˆ**: è”é‚¦å¹³å‡ + çŸ¥è¯†èåˆåŒé‡èšåˆæœºåˆ¶
3. **éšç§ä¿æŠ¤**: å®¢æˆ·ç«¯æ•°æ®ä¸å‡ºæœ¬åœ°ï¼Œåªäº¤æ¢æ¨¡å‹å‚æ•°
4. **æ³›åŒ–èƒ½åŠ›**: å¤šå®¢æˆ·ç«¯æ•°æ®åˆ†å¸ƒå¯èƒ½æå‡æ¨¡å‹æ³›åŒ–èƒ½åŠ›

## âš™ï¸ æ ¸å¿ƒæŠ€æœ¯ç»†èŠ‚

### è”é‚¦å­¦ä¹ ç­–ç•¥

æˆ‘ä»¬æ‰©å±•äº†Flowerçš„`FedAvg`ç­–ç•¥ï¼Œåœ¨`aggregate_fit`æ–¹æ³•ä¸­åŠ å…¥äº†MergeNetçŸ¥è¯†èåˆï¼š

```python
def aggregate_fit(self, server_round, results, failures):
    # 1. æ ‡å‡†è”é‚¦å¹³å‡
    aggregated_parameters, metrics = super().aggregate_fit(...)
    
    # 2. åº”ç”¨MergeNetçŸ¥è¯†èåˆ
    fused_parameters = self._apply_mergenet_knowledge_fusion(averaged_weights)
    
    # 3. è¿”å›èåˆåçš„å‚æ•°
    return fused_parameters, metrics
```

### çŸ¥è¯†èåˆæµç¨‹

1. **å‚æ•°æå–**: ä»å¹³å‡åçš„MobileNetV2å’ŒResNet50æå–å…³é”®å‚æ•°
2. **æ³¨æ„åŠ›è®¡ç®—**: ä½¿ç”¨ParamAttentionæ¨¡å—è®¡ç®—å‚æ•°é—´çš„æ³¨æ„åŠ›
3. **å‚æ•°èåˆ**: ç”Ÿæˆèåˆäº†å¤§æ¨¡å‹çŸ¥è¯†çš„æ–°å‚æ•°
4. **æ¨¡å‹æ›´æ–°**: å°†èåˆå‚æ•°åŠ è½½å›MobileNetV2

### å®¢æˆ·ç«¯è®­ç»ƒ

æ¯ä¸ªå®¢æˆ·ç«¯è¿›è¡Œæœ¬åœ°è®­ç»ƒï¼š
- æœ¬åœ°epochs: 5
- ä¼˜åŒ–å™¨: SGD (lr=0.1, momentum=0.9)
- å­¦ä¹ ç‡è°ƒåº¦: MultiStepLR

## ğŸ“ˆ å®éªŒç»“æœ

### è¯„ä¼°æŒ‡æ ‡

- **å‡†ç¡®ç‡**: Top1å’ŒTop5å‡†ç¡®ç‡
- **æŸå¤±**: è®­ç»ƒå’Œæµ‹è¯•æŸå¤±
- **æ”¶æ•›é€Ÿåº¦**: è¾¾åˆ°ç‰¹å®šå‡†ç¡®ç‡é˜ˆå€¼çš„è½®æ•°
- **æœ€ç»ˆæ€§èƒ½**: æœ€é«˜å‡†ç¡®ç‡å’Œæœ€ç»ˆç¨³å®šå‡†ç¡®ç‡

### å¯¹æ¯”ç»´åº¦

1. **åŸºçº¿æ–¹æ³•**: åŸå§‹`run_res50_mbv2.py`çš„å•æœºè®­ç»ƒ+çŸ¥è¯†èåˆ
2. **è”é‚¦æ–¹æ³•**: è”é‚¦å­¦ä¹ +çŸ¥è¯†èåˆçš„åˆ†å¸ƒå¼è®­ç»ƒ
3. **æ•ˆç‡å¯¹æ¯”**: è®­ç»ƒæ—¶é—´ã€é€šä¿¡å¼€é”€ã€æ”¶æ•›é€Ÿåº¦
4. **æ€§èƒ½å¯¹æ¯”**: æœ€ç»ˆå‡†ç¡®ç‡ã€æ¨¡å‹æ³›åŒ–èƒ½åŠ›

## ğŸ”§ é…ç½®å‚æ•°

### è”é‚¦å­¦ä¹ é…ç½®

```python
federated_config = {
    "server": {
        "num_rounds": 50,      # è”é‚¦å­¦ä¹ è½®æ•°
        "min_fit_clients": 2,  # æœ€å°‘å‚ä¸å®¢æˆ·ç«¯æ•°
    },
    "client": {
        "local_epochs": 5,     # æœ¬åœ°è®­ç»ƒè½®æ•°
        "learning_rate": 0.1,  # å­¦ä¹ ç‡
    },
    "knowledge_fusion": {
        "start_round": 2,      # å¼€å§‹èåˆçš„è½®æ•°
        "fusion_frequency": 1, # èåˆé¢‘ç‡
    }
}
```

### MergeNeté…ç½®

ä¿æŒä¸åŸå§‹å®éªŒä¸€è‡´çš„å‚æ•°æ³¨æ„åŠ›é…ç½®ï¼š

```yaml
d_attention: 64
h: 8
num_layers: 2
lr: 0.001
f: 1  # æ¯è½®éƒ½èåˆ
```

## ğŸ“ æ—¥å¿—å’Œç›‘æ§

### æ—¥å¿—æ–‡ä»¶

- `logs/federated_mergenet_server.log`: æœåŠ¡ç«¯æ—¥å¿—
- `logs/federated_mergenet_client.log`: å®¢æˆ·ç«¯æ—¥å¿—

### ç›‘æ§æŒ‡æ ‡

- æ¯è½®èšåˆåçš„å‡†ç¡®ç‡å’ŒæŸå¤±
- çŸ¥è¯†èåˆåº”ç”¨çŠ¶æ€
- å®¢æˆ·ç«¯å‚ä¸æƒ…å†µ
- é€šä¿¡è½®æ¬¡å’Œæ—¶é—´

## ğŸ¯ å®éªŒç›®æ ‡

é€šè¿‡è¿™ä¸ªå®ç°ï¼Œæˆ‘ä»¬æœŸæœ›éªŒè¯ï¼š

1. **è”é‚¦å­¦ä¹ æ˜¯å¦èƒ½ä¸MergeNetæœ‰æ•ˆç»“åˆ**
2. **åˆ†å¸ƒå¼è®­ç»ƒ+çŸ¥è¯†èåˆæ˜¯å¦ä¼˜äºå•æœºè®­ç»ƒ+çŸ¥è¯†èåˆ**
3. **é¢å¤–çš„è”é‚¦å¹³å‡æ­¥éª¤æ˜¯å¦æœ‰åŠ©äºæå‡æœ€ç»ˆæ€§èƒ½**
4. **åœ¨ä¿æŠ¤æ•°æ®éšç§çš„å‰æä¸‹æ˜¯å¦èƒ½è¾¾åˆ°ç›¸å½“çš„æ€§èƒ½**

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **CUDAå†…å­˜ä¸è¶³**: è°ƒæ•´batch_sizeæˆ–ä½¿ç”¨CPUè®­ç»ƒéƒ¨åˆ†å®¢æˆ·ç«¯
2. **ç½‘ç»œè¿æ¥é—®é¢˜**: æ£€æŸ¥æœåŠ¡ç«¯åœ°å€å’Œç«¯å£é…ç½®
3. **ä¾èµ–åŒ…ç‰ˆæœ¬**: ç¡®ä¿PyTorchå’ŒFlowerç‰ˆæœ¬å…¼å®¹

### è°ƒè¯•å»ºè®®

1. å…ˆè¿è¡Œå•å®¢æˆ·ç«¯æµ‹è¯•
2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
3. éªŒè¯æ¨¡å‹å‚æ•°ç»´åº¦åŒ¹é…
4. ç¡®è®¤æ•°æ®åŠ è½½æ­£å¸¸

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºåŸæœ‰MergeNeté¡¹ç›®ï¼Œéµå¾ªç›¸åŒçš„å¼€æºè®¸å¯è¯ã€‚
